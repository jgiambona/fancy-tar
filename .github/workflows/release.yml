name: Build & Release

on:
  push:
    tags:
      - 'v*'

jobs:
  package:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ· Set version from tag
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: ğŸ“ Create dist and build folders
        run: |
          mkdir -p dist build/fancy-tar-${VERSION}
          cp -r scripts docs completions install.sh README.md fancy-tar.spec build/fancy-tar-${VERSION}/

      - name: ğŸ“¦ Create versioned tarball
        run: |
          tar czvf dist/fancy-tar-${VERSION}.tar.gz -C build fancy-tar-${VERSION}

      - name: ğŸ§® Generate SHA256 checksum
        run: |
          cd dist
          sha256sum fancy-tar-${VERSION}.tar.gz > sha256.txt

      - name: ğŸ” Inject version into RPM spec
        run: |
          sed -i "s/^Version:.*/Version:        ${VERSION}/" fancy-tar.spec
          sed -i "s|^Source0:.*|Source0:        https://github.com/jgiambona/fancy-tar/releases/download/v${VERSION}/fancy-tar-${VERSION}.tar.gz|" fancy-tar.spec

      - name: ğŸ§° Install RPM build tools
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: ğŸ— Build RPM package
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp fancy-tar.spec ~/rpmbuild/SPECS/
          cp dist/fancy-tar-${VERSION}.tar.gz ~/rpmbuild/SOURCES/
          rpmbuild -ba ~/rpmbuild/SPECS/fancy-tar.spec
          find ~/rpmbuild/RPMS -name "*.rpm" -exec cp {} dist/ \;

      - name: ğŸ“¤ Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          files: |
            dist/fancy-tar-${{ env.VERSION }}.tar.gz
            dist/sha256.txt
            dist/*.rpm
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false
          generate_release_notes: false

      - name: ğŸ§¹ Cleanup
        run: rm -rf build

