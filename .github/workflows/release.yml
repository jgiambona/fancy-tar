name: Build & Release

on:
  push:
    tags:
      - 'v*'

jobs:
  package:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ· Set version from tag
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: ğŸ“ Create dist folder
        run: mkdir -p dist

      - name: ğŸ“¦ Create source tarball
        run: |
          tar czvf dist/fancy-tar-${VERSION}.tar.gz \
            scripts/fancy_tar_progress.sh \
            docs/fancy-tar.1 \
            completions/fancy-tar.bash \
            completions/fancy-tar.zsh \
            completions/fancy-tar.fish \
            install.sh \
            README.md \
            fancy-tar.spec

      - name: ğŸ” Inject version into RPM spec
        run: |
          sed -i "s/^Version:.*/Version:        ${VERSION}/" fancy-tar.spec
          sed -i "s|^Source0:.*|Source0:        https://github.com/jgiambona/fancy-tar/releases/download/v${VERSION}/fancy-tar-${VERSION}.tar.gz|" fancy-tar.spec

      - name: ğŸ§° Install RPM build tools
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: ğŸ— Build RPM package
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp fancy-tar.spec ~/rpmbuild/SPECS/
          cp dist/fancy-tar-${VERSION}.tar.gz ~/rpmbuild/SOURCES/
          rpmbuild -ba ~/rpmbuild/SPECS/fancy-tar.spec
          find ~/rpmbuild/RPMS -name "*.rpm" -exec cp {} dist/ \;

      - name: ğŸ“¤ Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/fancy-tar-${{ env.VERSION }}.tar.gz
            dist/*.rpm

